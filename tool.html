<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Down East flooding map locations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <style>
        #map {
            height: 90vh;
        }
        #export-btn {
            margin: 10px;
            padding: 5px 10px;
            background-color: #337ab7;
            color: white;
            border: none;
            cursor: pointer;
        }
        .hover-menu {
            position: absolute;
            background: white;
            padding: 5px;
            border: 1px solid #ccc;
            display: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="export-btn">Export markers</button>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

    <script>
        var map = L.map('map').setView([34.80158464213949, -76.66000448289184], 10);
        map.setMinZoom(10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
        }).addTo(map);

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polygon: false,
                polyline: false,
                rectangle: false,
                circle: {
                    shapeOptions: {
                        color: 'red'
                    },
                    repeatMode: true
                },
                marker: false,
                circlemarker: false
            }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (e) {
            var type = e.layerType,
                layer = e.layer;

            if (type === 'circle') {
                // Fix the radius to 1600 meters
                layer.setRadius(500);
            }

            // Add the layer to the FeatureGroup
            drawnItems.addLayer(layer);
        });


        var clickStyle =  {
            // radius: 10,
            fillColor: "#00ff00",
            color: "#00ff00",
            weight: 3,
            opacity: 1,
            fillOpacity: 0.2,
        }

        var unclickStyle = {
            // radius: 10,
            fillColor: "#ff0000",
            color: "#ff0000",
            weight: 3,
            opacity: 1,
            fillOpacity: 0.2,
        }

        function clickOnMarker(e){
            if (e.target.feature.properties.clicked) {
                e.target.setStyle(unclickStyle);
                e.target.feature.properties.clicked = false;
            } else {
                e.target.setStyle(clickStyle);
                e.target.feature.properties.clicked = true;
            }
        }

        var label_counter = 1;

        map.on('draw:created', function (e) {
            var layer = e.layer;
            if (e.layerType === 'circle') {
                var label = prompt('Enter label for the marker:');
                label = label_counter.toString() + ": " + label;
                label_counter++;
                layer.bindTooltip(label, { permanent: true }).openTooltip();
                layer.feature = {
                    type: 'Feature',
                    properties: {
                        label: label,
                        clicked: false
                    }
                };
                layer.on('click', clickOnMarker);
                layer.setStyle(unclickStyle)
            }
            drawnItems.addLayer(layer);
        });

        document.getElementById('export-btn').addEventListener('click', function() {
            var data = drawnItems.toGeoJSON();
            var blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            var url = URL.createObjectURL(blob);

            var a = document.createElement('a');
            a.href = url;
            a.download = 'markers.geojson';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        });

        window.onbeforeunload = function() {
            return "Are you sure you want to leave this page?";
        };
    </script>
</body>
</html>
