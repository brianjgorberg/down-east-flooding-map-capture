<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Down East flooding map locations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <style>
        * {margin: 0; padding: 0;}

        #map {
            height: 100vh;
            width: 70vw;
            float: left;
        }
        #controls {
            font-family: "Aptos", sans-serif;
            width: 28vw;
            float: right;
            padding: 1vw;
            height: 100vh;
            overflow-y: scroll;
        }
        #export-btn {
            margin: 10px;
            padding: 5px 10px;
            background-color: #337ab7;
            color: white;
            border: none;
            cursor: pointer;
        }
        #labels-table {
            width: 100%;
            border-collapse: collapse;
            cursor: pointer;
        }
        #labels-table th, #labels-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <button id="export-btn">Export markers</button>
        <table id="labels-table">
            <thead>
                <tr>
                    <th>Markers</th>
                    <th>Follow Up</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

    <script>
        var map = L.map('map').setView([34.80158464213949, -76.66000448289184], 10);
        map.setMinZoom(10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
        }).addTo(map);

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polygon: false,
                polyline: false,
                rectangle: false,
                circle: {
                    shapeOptions: {
                        color: 'red'
                    },
                    repeatMode: true
                },
                marker: false,
                circlemarker: false
            }
        });
        map.addControl(drawControl);

        var clickStyle =  {
            fillColor: "#00ff00",
            color: "#00ff00",
            weight: 3,
            opacity: 1,
            fillOpacity: 0.2,
        }

        var unclickStyle = {
            fillColor: "#ff0000",
            color: "#ff0000",
            weight: 3,
            opacity: 1,
            fillOpacity: 0.2,
        }

        function clickOnMarker(e){
            if (e.target.feature.properties.clicked) {
                e.target.setStyle(unclickStyle);
                e.target.feature.properties.clicked = false;
            } else {
                e.target.setStyle(clickStyle);
                e.target.feature.properties.clicked = true;
            }
            updateLabelsTable();
        }

        var label_counter = 1;

        map.on('draw:created', function (e) {
            var layer = e.layer;
            if (e.layerType === 'circle') {
                var label = prompt('Enter label for the marker:');
                label = label_counter.toString() + ": " + label;
                label_counter++;
                layer.bindTooltip(label, { permanent: true }).openTooltip();
                layer.feature = {
                    type: 'Feature',
                    properties: {
                        label: label,
                        clicked: false
                    }
                };
                layer.on('click', clickOnMarker);
                layer.setStyle(unclickStyle);
                drawnItems.addLayer(layer);
                updateLabelsTable();
                layer.setRadius(500);
            }
        });

        map.on('draw:deleted', function () {
            updateLabelsTable();
        });

        function updateLabelsTable() {
            var labels = [];
            drawnItems.eachLayer(function (layer) {
                if (layer.feature && layer.feature.properties.label) {
                    labels.push({
                        label: layer.feature.properties.label,
                        layer: layer
                    });
                }
            });

            // labels.sort((a, b) => a.label.localeCompare(b.label));

            var tableBody = document.querySelector('#labels-table tbody');
            tableBody.innerHTML = '';

            labels.forEach(function (item) {
                var row = document.createElement('tr');
                var labelCell = document.createElement('td');
                labelCell.textContent = item.label;
                var checkboxCell = document.createElement('td');
                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = item.layer.feature.properties.clicked;
                checkbox.disabled = true; // Make the checkbox read-only
                checkboxCell.appendChild(checkbox);
                row.appendChild(labelCell);
                row.appendChild(checkboxCell);
                tableBody.appendChild(row);

                row.addEventListener('click', function() {
                    map.setView(item.layer.getLatLng(), 14);
                    item.layer.openTooltip();
                    item.layer.setStyle(clickStyle);
                    item.layer.feature.properties.clicked = true;
                    updateLabelsTable();
                });
            });
        }

        document.getElementById('export-btn').addEventListener('click', function() {
            var data = drawnItems.toGeoJSON();
            var blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            var url = URL.createObjectURL(blob);

            var a = document.createElement('a');
            a.href = url;
            a.download = 'markers.geojson';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        });

        window.onbeforeunload = function() {
            return "Are you sure you want to leave this page?";
        };
    </script>
</body>
</html>